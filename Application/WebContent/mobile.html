<!DOCTYPE html>
<html>
<head>
		<title>First Mobile Example</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="libresources/external/jQuery_Mobile/jquery.mobile-1.4.5.min.css" />
        <script src="libresources/external/jQuery/2.1.0/jquery.js"></script>
		<script type="text/javascript" src="libresources/external/jQuery_Mobile/jquery.mobile-1.4.5.min.js"></script>

        <script src="libresources/external/Underscore/1.6.0/underscore.js"></script>
        <script src="libresources/external/Backbone/1.1.2/backbone.js"></script>
        <script src="libresources/external/log4javascript/1.0.0/log4javascript.js"></script>
        <script src="libresources/external/handlebars/handlebars-v4.0.11.js"></script>
        
    <style>
		/* Swipe works with mouse as well but often causes text selection. */
		#demo-page * {
		    -webkit-user-select: none;
		    -moz-user-select: none;
		    -ms-user-select: none;
		    -o-user-select: none;
		    user-select: none;
		}
		/* Arrow only buttons in the header. */
		#demo-page .ui-header .ui-btn {
		    background: none;
		    border: none;
		    top: 9px;
		}
		#demo-page .ui-header .ui-btn-inner {
		    border: none;
		}
		/* Content styling. */
		dl { font-family: "Times New Roman", Times, serif; padding: 1em; }
		dt { font-size: 2em; font-weight: bold; }
		dt span { font-size: .5em; color: #777; margin-left: .5em; }
		dd { font-size: 1.25em; margin: 1em 0 0; padding-bottom: 1em; border-bottom: 1px solid #eee; }
		.back-btn { float: right; margin: 0 2em 1em 0; }        
	</style>
</head>

<body>

	<div data-role="page" id="demo-page" data-theme="d" data-url="demo-page">
	    <div data-role="header" data-theme="b">
	        <h1>Swipe left or right</h1>
	        <a href="#left-panel" data-theme="d" data-icon="arrow-r" data-iconpos="notext" data-shadow="false" data-iconshadow="false" class="ui-icon-nodisc">Open left panel</a>
	        <a href="#right-panel" data-theme="d" data-icon="arrow-l" data-iconpos="notext" data-shadow="false" data-iconshadow="false" class="ui-icon-nodisc">Open right panel</a>
	    </div><!-- /header -->
	    <div data-role="content" id="content">
	    </div><!-- /content -->
	    <div data-role="panel" id="left-panel" data-theme="b">
			<ul data-role="listview" id="miniAppList"></ul>
	    </div><!-- /panel -->
	    <div data-role="panel" id="right-panel" data-display="push" data-position="right" data-theme="c">
	        <p>Right push panel.</p>
	        <a href="#" data-rel="close" data-role="button" data-mini="true" data-inline="true" data-icon="delete" data-iconpos="right">Close</a>
	    </div><!-- /panel -->
	    
	    <div data-role="popup" id="settingNameForm" data-theme="a" class="ui-corner-all" data-dismissible="false">
		    <form>
		        <div style="padding:10px 20px;">
		            <h3>Setting Name</h3>
		            <label for="un" class="ui-hidden-accessible">Username:</label>
		            <input type="text" id="settingNameInput" value="" placeholder="setting name" data-theme="a">
					<a href="#" id="settingNameSubmit" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b">Submit</a>
        			<a href="#" id="settingNameCancel" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-transition="flow">Cancel</a>		        </div>
		    </form>
		</div>
	    
	</div>

</body>


<script>
	$(document).on("pageinit", "#demo-page", function() {
		$(document).on("swipeleft swiperight", "#demo-page", function(e) {
			if ($.mobile.activePage.jqmData("panel") !== "open") {
				if (e.type === "swipeleft") {
					$("#right-panel").panel("open");
				} else if (e.type === "swiperight") {
					$("#left-panel").panel("open");
				}
			}
		});
		$("#settingNameCancel").click(function(e){
			$("#settingNameForm").popup("close"); 
		});
		$("#settingNameSubmit").click(function(e){
			var id = $("#settingNameForm").popup("option", "settingId");
			var settingName = $("#settingNameInput").val();
			createSetting(id, settingName);
			$("#settingNameForm").popup("close"); 
		});
	});
</script>

<script src="libresources/nosliw/core/nosliw.js"></script>
<script>

	var setting = [];

	var createSetting = function(id, settingName){
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");
		var node_dataUtility = nosliw.getNodeData("uidata.data.utility");
		var node_CONSTANT = nosliw.getNodeData("constant.CONSTANT");
		var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");
		var node_createServiceRequestInfoSequence = nosliw.getNodeData("request.request.createServiceRequestInfoSequence");
		var node_requestServiceProcessor = nosliw.getNodeData("request.requestServiceProcessor");

		var settingData = getSettingById(id);
		
		var out = node_createServiceRequestInfoSequence({}, {
			success : function(requestInfo){
													
			}
		});
		out.addRequest(getDataFromUIResourceViewRequest(settingData.uiResourceView, {
			success : function(requestInfo, data){
				settingData.dataInfo.version = settingName;
				settingData.dataInfo.data = data;
				settingData.dataInfo.type = "setting";
				settingData.isNew = false;
				return nosliw.runtime.getMiniAppService().getSaveDataRequest(settingData.userId, settingData.appId, settingData.dataName, settingData.dataInfo, {
					success : function(requestInfo, instanceData){
						settingData.dataId = instanceData[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPDATA_ID];
						$("#settingVersion_"+id).text(settingName);
						
						
						var newSettingData = {
							id : nosliw.generateId(),
							userId : settingData.userId,
							appId : settingData.appId,
							dataName : settingData.dataName,
							isNew : true,
							dataInfo : {
								version : "Setting"
							},
							uiResource : settingData.uiResource,
							service : settingData.service,
							parentView : settingData.parentView,
							miniAppEntry : settingData.miniAppEntry
						};
						
						addSetting(newSettingData, newSettingData.parentView, newSettingData.miniAppEntry);
					}
				});
			}
		}));
		node_requestServiceProcessor.processRequest(out);
		
	};
	
	var getSettingById = function(id){
		var out;
		_.each(setting, function(s){
			if(s.id==id) out = s;  
		});
		return out;
	};
	
	var showContent = function(page){
		$('#content').empty();
		nosliw.runtime.getUIResourceService()
		.executeCreateUIResourceViewRequest(
				page,
				{
					success : function(requestInfo,
							uiResourceView) {
						nosliw.logging.info(JSON
								.stringify(uiResourceView));

						uiResourceView.appendTo($('#content'));
					}
				});
	};

	var showAppResult = function(parentView, uiModuleInstance, appData){
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");
		var node_dataUtility = nosliw.getNodeData("uidata.data.utility");
		var node_CONSTANT = nosliw.getNodeData("constant.CONSTANT");
		var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");

		var uiModule = uiModuleInstance[node_COMMONATRIBUTECONSTANT.INSTANCEUIMODULE_UIMODULEENTRY];
		var entryPage = uiModule[node_COMMONATRIBUTECONSTANT.UIMODULEENTRY_ENTRYPAGE];
		var uiResource = uiModule[node_COMMONATRIBUTECONSTANT.UIMODULEENTRY_PAGES][entryPage];
		nosliw.runtime.getUIResourceService().executeGenerateUIResourceViewRequest(uiResource, {
			success : function(requestInfo, uiResourceView){
				uiResourceView.appendTo(parentView);
				uiResourceView.executeDefaultDataOperationRequestSet(appData, node_CONSTANT.DATA_TYPE_APPDATA);
			}
		}); 

	};
	
	var showSetting = function(userId, appId, parentView, uiModuleInstance, appData, miniAppEntry){
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");
		var node_dataUtility = nosliw.getNodeData("uidata.data.utility");
		var node_CONSTANT = nosliw.getNodeData("constant.CONSTANT");
		var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");
		
		parentView.empty();
		var collapsibleSet = $("<div data-role='collapsibleset' data-theme='a' data-content-theme='a'></div>");
		parentView.append(collapsibleSet);
		
		var uiModule = uiModuleInstance[node_COMMONATRIBUTECONSTANT.INSTANCEUIMODULE_UIMODULEENTRY];
		var entryPage = uiModule[node_COMMONATRIBUTECONSTANT.UIMODULEENTRY_ENTRYPAGE];
		var uiResource = uiModule[node_COMMONATRIBUTECONSTANT.UIMODULEENTRY_PAGES][entryPage];
		
		var moduleDataDef = uiModuleInstance[node_COMMONATRIBUTECONSTANT.INSTANCEUIMODULE_DATA];
		var moduleServiceDef = uiModuleInstance[node_COMMONATRIBUTECONSTANT.INSTANCEUIMODULE_SERVICE];
		var moduleDataName = moduleDataDef[node_COMMONCONSTANT.MINIAPPUIENTRY_MAINMOBILE_DATA_MAIN];
		var moduleData =  appData==undefined?undefined : appData[moduleDataName];
		if(moduleData!=undefined){
			_.each(moduleData, function(moduleData, list){
				var settingData = {
					id : nosliw.generateId(),	
					dataId : moduleData[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPDATA_ID],
					userId : userId,
					appId : appId,
					dataName : moduleDataName,
					isNew : false,
					dataInfo : {
					},
					uiResource : uiResource,
					service : moduleServiceDef
				};
				settingData.dataInfo[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPDATA_VERSION] = moduleData[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPDATA_VERSION];
				settingData.dataInfo[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPDATA_DATA] = moduleData[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPDATA_DATA];
				setting.push(settingData);
			});
		}

		setting.push({
			id : nosliw.generateId(),
			userId : userId,
			appId : appId,
			dataName : moduleDataName,
			isNew : true,
			dataInfo : {
				version : "Setting"
			},
			uiResource : uiResource,
			service : moduleServiceDef
		});

		_.each(setting, function(settingData, index){
			addSetting(settingData, collapsibleSet, miniAppEntry);
		});
		
	};
	
	var addSetting = function(settingData, collapsibleSet, miniAppEntry){
		
		var node_createServiceRequestInfoSequence = nosliw.getNodeData("request.request.createServiceRequestInfoSequence");
		var node_requestServiceProcessor = nosliw.getNodeData("request.requestServiceProcessor");
		var node_CONSTANT = nosliw.getNodeData("constant.CONSTANT");
		var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");

		settingData.parentView = collapsibleSet;
		settingData.miniAppEntry = miniAppEntry; 
		
		nosliw.runtime.getUIResourceService().executeGenerateUIResourceViewRequest(settingData.uiResource, 
				{
					success : function(requestInfo, uiResourceView){
						settingData.uiResourceView = uiResourceView;
						var template = Handlebars.compile(document.getElementById("setting-template").innerHTML);
						var singleDataView = template(settingData);
						collapsibleSet.append(singleDataView);
						
						uiResourceView.appendTo(collapsibleSet);
						
						if(settingData.dataInfo.data!=undefined){
							_.each(settingData.dataInfo.data, function(parm, name){
								uiResourceView.executeDataOperationRequestSet(name, parm.value, parm.dataTypeInfo);
							});
						}
						
						$("#settingSubmit_"+settingData.id).click(function(e) {
							var request = node_createServiceRequestInfoSequence({}, {});
							
							var getParmsRequest = uiResourceView.getContext().getValueAsParmsRequest({
								success : function(requestInfo, parms){
									var serviceName = node_COMMONCONSTANT.MINIAPPUIENTRY_MAINMOBILE_SERVICE_MAIN;
									return nosliw.runtime.getMiniAppService().getExecuteServiceRequest(serviceName, settingData.service, parms, {
										success : function(requestInfo, resultData){
											var appUIModule = miniAppEntry[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPUIENTRY_UIMODULES][node_COMMONCONSTANT.MINIAPPUIENTRY_MAINMOBILE_MODULE_APPLICATION];
											showAppResult($('#CONTENT'), appUIModule, resultData);
										}
									});
								}
							});
							
							request.addRequest(getParmsRequest);
							node_requestServiceProcessor.processRequest(request);
							e.preventDefault();
						});

						
						$("#settingSave_"+settingData.id).click(function(e) {
							$("#settingNameForm").popup( "option", "settingId", settingData.id );
							$("#settingNameForm").popup("open"); 
							e.preventDefault();
						});
						
					}
				});
			
	};
	
	var getDataFromUIResourceViewRequest = function(uiResourceView, handlers, requestInfo){
		var node_createServiceRequestInfoSequence = nosliw.getNodeData("request.request.createServiceRequestInfoSequence");
		var node_createServiceRequestInfoSet = nosliw.getNodeData("request.request.createServiceRequestInfoSet");
		var node_createUIDataOperationRequest = nosliw.getNodeData("uidata.uidataoperation.createUIDataOperationRequest");
		var node_UIDataOperation = nosliw.getNodeData("uidata.uidataoperation.UIDataOperation");
		var node_uiDataOperationServiceUtility = nosliw.getNodeData("uidata.uidataoperation.uiDataOperationServiceUtility");

		var setRequest = node_createServiceRequestInfoSet({}, {
			success : function(requestInfo, result){
				var out = {};
				_.each(result.getResults(), function(contextData, name){
//					out[name] = contextData.value;
					out[name] = contextData;
				});
				return out;
			}
		}, requestInfo);
		_.each(uiResourceView.getContext().getElementsName(), function(eleName, index){
			setRequest.addRequest(eleName, node_createUIDataOperationRequest(uiResourceView.getContext(), new node_UIDataOperation(eleName, node_uiDataOperationServiceUtility.createGetOperationService())));
		});

		var outRequest = node_createServiceRequestInfoSequence({}, handlers, requestInfo);
		outRequest.addRequest(setRequest);		

		return outRequest;
	};
	
	
	
	var onSaveEvent = function(){
		
		
	}; 
	
	var saveData = function(){
		
	};
	
	var showApp = function(userId, miniAppId, appEntry){
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");
		var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");
		var miniAppService = nosliw.runtime.getMiniAppService();
		miniAppService.executeLoadMiniAppUIEntryRequest(userId, miniAppId, appEntry, {
			success : function(requestInfo, miniAppEntry){
				var settingUIModule = miniAppEntry[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPUIENTRY_UIMODULES][node_COMMONCONSTANT.MINIAPPUIENTRY_MAINMOBILE_MODULE_SETTING];
				var data = miniAppEntry[node_COMMONATRIBUTECONSTANT.INSTANCEMINIAPPUIENTRY_DATA]
				showSetting(userId, miniAppId, $('#right-panel'), settingUIModule, data, miniAppEntry);
			}
		});
		return false;
	};

	var onClickMiniApp = function(viewId, miniAppId, userId){
		var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");
		$("#"+viewId).click(function(e) {
			showApp(userId, miniAppId, node_COMMONCONSTANT.MINIAPPUIENTRY_NAME_MAINMOBILE);
			e.preventDefault();
		});
	};
	
	var showUserInfo = function(userInfo){
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");
		var listView = $("#miniAppList");
		_.each(userInfo[node_COMMONATRIBUTECONSTANT.USERINFO_MINIAPPS], function(miniApp, index){
			appendMiniApp(listView, miniApp, userInfo[node_COMMONATRIBUTECONSTANT.USERINFO_USER][node_COMMONATRIBUTECONSTANT.USER_ID]);
		});

		_.each(userInfo[node_COMMONATRIBUTECONSTANT.USERINFO_GROUPMINIAPP], function(groupMiniAppInstance, index){
			appendMiniAppGroup(listView, groupMiniAppInstance);
		});
		
		$("#miniAppList").listview('refresh');
	};
	
	var appendMiniApp = function(parentView, miniApp, userId){
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");
		var miniAppId = miniApp[node_COMMONATRIBUTECONSTANT.USERMINIAPPINFO_APPID];
		var viewId = "miniAppInstanceId_" + miniAppId;
		var mininAppItemView = $("<li><a id=\""+viewId+"\" href=\"#\">"+miniApp[node_COMMONATRIBUTECONSTANT.USERMINIAPPINFO_APPNAME]+"</a></li>");
		parentView.append(mininAppItemView);
		onClickMiniApp(viewId, miniAppId, userId);
	};
	
	var appendMiniAppGroup = function(parentView, miniAppGroup, userId){
		var node_COMMONATRIBUTECONSTANT = nosliw.getNodeData("constant.COMMONATRIBUTECONSTANT");
		var groupId = miniAppGroup[node_COMMONATRIBUTECONSTANT.USERGROUPMINIAPP_GROUP][node_COMMONATRIBUTECONSTANT.GROUP_ID];
		var groupName = miniAppGroup[node_COMMONATRIBUTECONSTANT.USERGROUPMINIAPP_GROUP][node_COMMONATRIBUTECONSTANT.GROUP_NAME];
		var groupViewId = "groupMiniAppId_" + groupId;
		
		var groupView = $("<li><div data-role='collapsible' id='collapsible_"+groupViewId+"' data-collapsed='true'><h4>"+groupName+"</h4><ul data-role='listview' id='"+groupViewId+"'></ul></div></li>");
		parentView.append(groupView);
		
		_.each(miniAppGroup[node_COMMONATRIBUTECONSTANT.USERGROUPMINIAPP_MINIAPPS], function(miniApp, index){
			appendMiniApp($("#"+groupViewId), miniApp, userId);
		});
		$("#"+groupViewId).listview();
		$("#collapsible_"+groupViewId).collapsible();
		
	};
	
	nosliw.registerNodeEvent("runtime", "active",
		function(eventName, nodeName) {
			var miniAppService = nosliw.runtime.getMiniAppService();
			var userInfo = {};
			var userId = localStorage.userId;
			if(userId!=undefined){
				userInfo.user = {};
				userInfo.user.id = userId;
			}
			miniAppService.executeLoginRequest(userInfo, {
				success : function(requestInfo, userInfo){
					localStorage.userId = userInfo.user.id;
					showUserInfo(userInfo);
				}
			});
		
			
//			showContent("Example_App_Query_MyRealtor");
			
			
			
		}
	);
</script>
<script src="libresources/nosliw/runtimebrowserinit/init.js"></script>

<script id="setting-template" type="text/x-handlebars-template">
	<div id='setting_{{id}}' data-role='collapsible'>
		<h3><span id=settingVersion_{{id}}>{{dataInfo.version}}</span><a id='settingSave_{{id}}' href='#'>Save</a></h3><p></p>
		<a id='settingSubmit_{{id}}' href='#'>Execute</a>
	</div>
</script>

</html>
