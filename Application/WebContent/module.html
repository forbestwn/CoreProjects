<!DOCTYPE html>
<html>
<head>
        <meta charset="utf-8" />
        <title>Nosliw Go Go !!</title>

   		<link rel="stylesheet" href="libresources/external/jQuery_Mobile/jquery.mobile-1.4.5.min.css" />
        <script src="libresources/external/jQuery/2.1.0/jquery.js"></script>
        
        <script src="libresources/external/log4javascript/1.0.0/log4javascript.js"></script>
		<script src="libresources/nosliw/runtimebrowserinit/init.js"></script>


<!--  		<script type="text/javascript" src="libresources/external/jQuery_Mobile/jquery.mobile-1.4.5.min.js"></script>   --> 

		<meta name="viewport" content="width=device-width, initial-scale=1">

</head>

<body>
	 <div id="map"></div>

	<div id="testDiv">
	</div>

</body>

<script>


var loc_getModuleRuntimeRequest = function(moduleId, handlers, request){
	var loc_envFactory = function(uiModule){
		var node_createServiceRequestInfoSimple = nosliw.getNodeData("request.request.createServiceRequestInfoSimple");
		var node_createServiceRequestInfoSet = nosliw.getNodeData("request.request.createServiceRequestInfoSet");
		var node_createServiceRequestInfoSequence = nosliw.getNodeData("request.request.createServiceRequestInfoSequence");
		var node_ServiceInfo = nosliw.getNodeData("common.service.ServiceInfo");
		var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");
		
		var loc_uiModule = uiModule;
		var loc_uiStacks = []; 
		
		
		var loc_getUpdateBackIconsRequest = function(handlers, request){
			var out = node_createServiceRequestInfoSet(undefined, handlers, request);
			_.each(loc_uiStacks, function(ui, index){
				var displayStyle = "inline";
				if(index==0){
					displayStyle = "none";
				}
				out.addRequest(ui.getName(), ui.getUpdateContextRequest({
					HEADER___backIconDisplay : displayStyle
				}));
			});
			return out;
		};

		var loc_transferBack = function(){
			loc_uiStacks.pop();
			
			$.mobile.back();
		};
		
		var loc_out = {
				
				getPresentUIRequest : function(uiName, mode, handlers, requestInfo){
					$.mobile.changePage($("#"+uiName));
					loc_uiStacks.push(loc_uiModule.getUI(uiName));
					return loc_getUpdateBackIconsRequest(handlers, requestInfo);
				},
				
				getPreStartModuleRequest :function(handlers, requestInfo){
					out = node_createServiceRequestInfoSequence(new node_ServiceInfo("PreExecuteModule", {"uiModule":uiModule}), handlers, requestInfo);
					_.each(loc_uiModule.getUIs(), function(ui, index){
						
						ui.registerEventListener(undefined, function(event, eventData, requestInfo){
							if(event=="transferBack"){
								loc_transferBack();
							}
						});
						
						var processUIRequest = node_createServiceRequestInfoSequence();
						processUIRequest.addRequest(nosliw.runtime.getUIPageService().getCreateUIPageRequest("Fram_normal", undefined, {
							success :function(requestInfo, page){
								var decoration = loc_createDecoration(page.getUIView());
								ui.addDecoration(decoration);
								ui.getPage().appendTo($('#testDiv'));
								
								var contextValue = {
									ui :{
										id : ui.getName(),
										title : ui.getName()
									}
								};
								return page.getUpdateContextRequest(contextValue);								
							}
						}));
						out.addRequest(processUIRequest);
					});
					return out;
				},

				getExecuteCommandRequest : function(uiName, commandName, commandData, handlers, requestInfo){
					return loc_uiModule.getUI(uiName).getExecuteCommandRequest(commandName, commandData, handlers, requestInfo);
				}
				
		};
		return loc_out;
	};
		
	nosliw.runtime.getUIModuleService().executeGetUIModuleRuntimeRequest(moduleId, undefined, loc_envFactory, handlers, request);
};

var loc_createDecoration = function(uiView, appendId){
	var node_createServiceRequestInfoSequence = nosliw.getNodeData("request.request.createServiceRequestInfoSequence");
	var node_ServiceInfo = nosliw.getNodeData("common.service.ServiceInfo");
	var node_createEventObject = nosliw.getNodeData("common.event.createEventObject");
	
	var loc_eventSource = node_createEventObject();
	var loc_eventListenerForDec = node_createEventObject();
	var loc_eventListenerForParent = node_createEventObject();

	var loc_parent;
	
	var loc_uiView = uiView;

	loc_uiView.registerEventListener(loc_eventListenerForDec, function(event, eventData, requestInfo){
		loc_eventSource.triggerEvent(event, eventData, requestInfo);
	});

	var loc_out = {
		
		getName : function(){	return "HEADER___";	},
			
		setParent : function(parent){
			loc_parent = parent;
			loc_parent.appendTo(loc_uiView.getElementByAttributeValue('id', 'pleaseEmbed'));
			loc_parent.registerEventListener(loc_eventListenerForParent, function(event, eventData, requestInfo){
				loc_eventSource.triggerEvent(event, eventData, requestInfo);
			});
		},	
		appendTo : function(ele){
			loc_uiView.appendTo(ele);
		},
		insertAfter : function(ele){
			loc_uiView.insertAfter(ele);
		},
		detachViews : function(){
			
		},
		getUpdateContextRequest : function(parms, handlers, requestInfo){
			var parmsForDec = {};
			var parmsUpdated = {};
			var parmsForDecSum = 0;
			var parmsUpdatedSum = 0;
			_.each(parms, function(parm, name){
				if(name.startsWith(loc_out.getName())){
					parmsForDec[name.substring(loc_out.getName().length)] = parm;
					parmsForDecSum++;
				}
				else{
					parmsUpdated[name] = parm;
					parmsUpdatedSum++;
				}
			});
			out = node_createServiceRequestInfoSequence(undefined, handlers, requestInfo);
			if(parmsForDecSum>0) out.addRequest(loc_uiView.getUpdateContextRequest(parmsForDec));
			else if(parmsUpdatedSum>0)  out.addRequest(loc_parent.getUpdateContextRequest(parmsUpdated));
			return out;
		},
		command : function(command, parms, requestInfo){
			return loc_parent.command(command, parms, requestInfo);
		},
		getContext : function(){
			return loc_parent.getContext();
		},
		registerEventListener : function(listener, handler, thisContext){	return loc_eventSource.registerListener(undefined, listener, handler, thisContext);},
		unregisterEventListener : function(listener){	return loc_eventSource.unregister(listener);},

	};
	
	return loc_out;
};


$(document).on("nosliwActive", function(){
	var node_createServiceRequestInfoSequence = nosliw.getNodeData("request.request.createServiceRequestInfoSequence");
	var node_requestServiceProcessor = nosliw.getNodeData("request.requestServiceProcessor");
	var node_COMMONCONSTANT = nosliw.getNodeData("constant.COMMONCONSTANT");

    // Our initialization code here
	var currentSearchString = window.location.search;
	var moduleId = currentSearchString.substring(currentSearchString.indexOf("=")+1);

	//create module runtime
	loc_getModuleRuntimeRequest(moduleId, {
		success : function(request, moduleRuntime){
			$(document).bind("mobileinit", function() {
				moduleRuntime.executeStartRequest();
			});

			nosliw.runtime.getResourceService().executeGetResourceDataByTypeRequest(["external.jQuery_Mobile;1.4.5"], node_COMMONCONSTANT.RUNTIME_RESOURCE_TYPE_JSLIBRARY, {
				success : function(requestInfo, data){
					var kkkk = 5555;
					kkkk++;
				}
			});
		}
	});
});

nosliw.init();
</script>

</html>
